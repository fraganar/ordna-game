<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Challenge Data</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #da190b;
        }
        pre {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Fix Challenge Data Issue</h1>

    <div class="section">
        <h2>Problem</h2>
        <p>När vi uppdaterade completeChallenge() för att inkludera playerId, blev parametrarna förskjutna för challenges som redan körts.</p>
        <p><strong>Detta script fixar befintliga challenges med fel data.</strong></p>
    </div>

    <div class="section">
        <h2>Step 1: Analyze Broken Challenges</h2>
        <button onclick="analyzeChallenges()">Analyze All Challenges</button>
        <div id="analysis"></div>
    </div>

    <div class="section">
        <h2>Step 2: Fix Broken Challenges</h2>
        <p style="color: red;"><strong>⚠️ VARNING: Detta kommer uppdatera Firebase-data permanent!</strong></p>
        <button onclick="fixChallenges()" style="background: #ff9800;">Fix Broken Challenges</button>
        <div id="fix-result"></div>
    </div>

    <!-- Firebase CDN Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        let brokenChallenges = [];

        async function analyzeChallenges() {
            const resultDiv = document.getElementById('analysis');

            try {
                const snapshot = await firebase.firestore()
                    .collection('challenges')
                    .get();

                brokenChallenges = [];
                let html = '<h3>Analysis Results:</h3>';

                snapshot.forEach(doc => {
                    const challenge = doc.data();
                    let issues = [];

                    // Check if opponent data is shifted (playerId looks like a name, name looks like playerId)
                    if (challenge.opponent) {
                        const opponent = challenge.opponent;

                        // Check if name looks like a playerId (starts with player_)
                        if (opponent.name && opponent.name.startsWith('player_')) {
                            issues.push('Opponent name looks like playerId: ' + opponent.name);
                        }

                        // Check if totalScore is not a number
                        if (typeof opponent.totalScore !== 'number') {
                            issues.push('Opponent totalScore is not a number: ' + opponent.totalScore);
                        }

                        // Check if questionScores is not an array
                        if (opponent.questionScores && !Array.isArray(opponent.questionScores)) {
                            issues.push('Opponent questionScores is not an array');
                        }
                    }

                    if (issues.length > 0) {
                        brokenChallenges.push({
                            id: challenge.id,
                            data: challenge,
                            issues: issues
                        });
                    }
                });

                html += `<p>Found ${brokenChallenges.length} broken challenge(s) out of ${snapshot.size} total.</p>`;

                if (brokenChallenges.length > 0) {
                    html += '<h4>Broken Challenges:</h4>';
                    brokenChallenges.forEach(broken => {
                        html += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ff9800;">`;
                        html += `<strong>${broken.id}</strong><br>`;
                        html += `Issues:<br>`;
                        broken.issues.forEach(issue => {
                            html += `- ${issue}<br>`;
                        });

                        if (broken.data.opponent) {
                            html += `<br>Current opponent data:<pre>${JSON.stringify(broken.data.opponent, null, 2)}</pre>`;
                        }
                        html += `</div>`;
                    });
                }

                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        async function fixChallenges() {
            const resultDiv = document.getElementById('fix-result');

            if (brokenChallenges.length === 0) {
                resultDiv.innerHTML = '<p>No broken challenges to fix. Run analysis first.</p>';
                return;
            }

            if (!confirm(`Are you sure you want to fix ${brokenChallenges.length} broken challenge(s)?`)) {
                return;
            }

            let html = '<h3>Fixing challenges...</h3>';
            let fixed = 0;
            let failed = 0;

            for (const broken of brokenChallenges) {
                try {
                    const opponent = broken.data.opponent;

                    // Check if data is shifted (parameters were in wrong order)
                    if (opponent && opponent.name && opponent.name.startsWith('player_')) {
                        // Data appears shifted:
                        // name contains playerId
                        // totalScore contains playerName
                        // questionScores contains totalScore
                        // actual questionScores is missing

                        const fixedOpponent = {
                            playerId: opponent.name,  // Was in name field
                            name: opponent.totalScore || 'Unknown',  // Was in totalScore field
                            totalScore: typeof opponent.questionScores === 'number' ? opponent.questionScores : 0,  // Was in questionScores field
                            questionScores: [],  // Lost in the shift, set to empty
                            completedAt: opponent.completedAt
                        };

                        // Update in Firebase
                        await firebase.firestore()
                            .collection('challenges')
                            .doc(broken.id)
                            .update({
                                opponent: fixedOpponent
                            });

                        html += `<div style="color: green;">✅ Fixed ${broken.id}</div>`;
                        fixed++;
                    } else {
                        html += `<div style="color: orange;">⚠️ Skipped ${broken.id} - doesn't match expected pattern</div>`;
                    }

                } catch (error) {
                    html += `<div style="color: red;">❌ Failed to fix ${broken.id}: ${error.message}</div>`;
                    failed++;
                }
            }

            html += `<hr><p><strong>Summary:</strong> Fixed ${fixed}, Failed ${failed}</p>`;
            html += `<p>Note: questionScores arrays were lost during the parameter shift and set to empty arrays.</p>`;

            resultDiv.innerHTML = html;
        }

        // Auto-analyze on load
        window.addEventListener('load', () => {
            setTimeout(analyzeChallenges, 1000);
        });
    </script>
</body>
</html>