<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firebase Queries</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .test {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        pre {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .error {
            color: red;
            background: #ffeaea;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background: #e8f8e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Test Firebase Queries for getUserChallenges</h1>

    <div class="test">
        <h2>Current Setup</h2>
        <div id="setup"></div>
    </div>

    <div class="test">
        <h2>1. Test Direct Queries</h2>
        <button onclick="testDirectQueries()">Run Direct Firebase Queries</button>
        <div id="direct-result"></div>
    </div>

    <div class="test">
        <h2>2. Test getUserChallenges Function</h2>
        <button onclick="testGetUserChallenges()">Run getUserChallenges()</button>
        <div id="function-result"></div>
    </div>

    <div class="test">
        <h2>3. Show All Challenges</h2>
        <button onclick="showAllChallenges()">Show All Challenges in Firebase</button>
        <div id="all-challenges"></div>
    </div>

    <!-- Firebase CDN Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        const playerId = localStorage.getItem('playerId');

        // Show setup
        function showSetup() {
            document.getElementById('setup').innerHTML = `
                <p><strong>Your playerId:</strong> ${playerId || 'Not set'}</p>
                <p><strong>Your playerName:</strong> ${localStorage.getItem('playerName') || 'Not set'}</p>
            `;
        }

        // Test direct Firebase queries
        async function testDirectQueries() {
            const resultDiv = document.getElementById('direct-result');
            let html = '<h3>Testing Direct Queries:</h3>';

            try {
                // Query 1: Challenges where I'm challenger
                html += '<h4>Query 1: Where I am challenger (challenger.playerId == my playerId)</h4>';
                try {
                    const q1 = await firebase.firestore()
                        .collection('challenges')
                        .where('challenger.playerId', '==', playerId)
                        .get();

                    html += `<div class="success">Found ${q1.size} challenge(s) where you are challenger</div>`;

                    if (q1.size > 0) {
                        q1.forEach(doc => {
                            const data = doc.data();
                            html += `<pre>ID: ${data.id}
Challenger PlayerId: ${data.challenger?.playerId}
Challenger Name: ${data.challenger?.name}</pre>`;
                        });
                    }
                } catch (e1) {
                    html += `<div class="error">Error: ${e1.message}</div>`;
                    if (e1.message.includes('index')) {
                        html += `<div class="error">⚠️ Firebase index needed! Click the link in browser console to create it.</div>`;
                    }
                }

                // Query 2: Challenges where I'm opponent
                html += '<h4>Query 2: Where I am opponent (opponent.playerId == my playerId)</h4>';
                try {
                    const q2 = await firebase.firestore()
                        .collection('challenges')
                        .where('opponent.playerId', '==', playerId)
                        .get();

                    html += `<div class="success">Found ${q2.size} challenge(s) where you are opponent</div>`;

                    if (q2.size > 0) {
                        q2.forEach(doc => {
                            const data = doc.data();
                            html += `<pre>ID: ${data.id}
Opponent PlayerId: ${data.opponent?.playerId}
Opponent Name: ${data.opponent?.name}</pre>`;
                        });
                    }
                } catch (e2) {
                    html += `<div class="error">Error: ${e2.message}</div>`;
                    if (e2.message.includes('index')) {
                        html += `<div class="error">⚠️ Firebase index needed! Click the link in browser console to create it.</div>`;
                    }
                }

            } catch (error) {
                html += `<div class="error">General error: ${error.message}</div>`;
            }

            resultDiv.innerHTML = html;
        }

        // Test getUserChallenges function
        async function testGetUserChallenges() {
            const resultDiv = document.getElementById('function-result');

            try {
                const challenges = await FirebaseAPI.getUserChallenges(playerId);

                resultDiv.innerHTML = `
                    <h3>getUserChallenges() Result:</h3>
                    <div class="success">Returned ${challenges.length} challenge(s)</div>
                    <pre>${JSON.stringify(challenges.map(c => ({
                        id: c.id,
                        role: c.role,
                        challengerPlayerId: c.challenger?.playerId,
                        opponentPlayerId: c.opponent?.playerId
                    })), null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <h3>getUserChallenges() Result:</h3>
                    <div class="error">Error: ${error.message}</div>
                `;
            }
        }

        // Show all challenges
        async function showAllChallenges() {
            const resultDiv = document.getElementById('all-challenges');

            try {
                const snapshot = await firebase.firestore()
                    .collection('challenges')
                    .orderBy('created', 'desc')
                    .limit(10)
                    .get();

                let html = `<h3>All Challenges (latest 10):</h3>`;
                html += `<p>Total found: ${snapshot.size}</p>`;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd;">`;
                    html += `<strong>${data.id}</strong><br>`;
                    html += `Challenger: ${data.challenger?.name} (playerId: ${data.challenger?.playerId || 'MISSING'})<br>`;
                    html += `Opponent: ${data.opponent?.name || 'Not played'} (playerId: ${data.opponent?.playerId || 'MISSING/Not played'})<br>`;
                    html += `Status: ${data.status}<br>`;
                    html += `</div>`;
                });

                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            showSetup();
        });
    </script>
</body>
</html>