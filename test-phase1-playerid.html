<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fas 1 - PlayerId Konsistens</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 25px;
            margin: 25px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #34495e;
            margin-top: 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        button.danger {
            background: #e74c3c;
        }
        button.danger:hover {
            background: #c0392b;
        }
        button.success {
            background: #27ae60;
        }
        button.success:hover {
            background: #229954;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
        }
        .success {
            background: #efe;
            border: 1px solid #cfc;
            color: #060;
        }
        .info {
            background: #f0f8ff;
            border: 1px solid #cde;
            color: #036;
        }
        .warning {
            background: #ffeaa7;
            border: 1px solid #fdcb6e;
            color: #6c5ce7;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-pass {
            background: #d4edda;
            color: #155724;
        }
        .status-fail {
            background: #f8d7da;
            color: #721c24;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .current-state {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .current-state h3 {
            margin-top: 0;
            color: #495057;
        }
        .state-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .state-item:last-child {
            border-bottom: none;
        }
        .state-value {
            font-family: 'Courier New', monospace;
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>üîß Test Fas 1 - PlayerId Konsistens</h1>

    <div class="test-section">
        <h2>üìä Nuvarande State</h2>
        <div class="current-state">
            <div id="current-state-display">
                <div class="state-item">
                    <span>PlayerId (localStorage):</span>
                    <span class="state-value" id="current-playerid">Laddar...</span>
                </div>
                <div class="state-item">
                    <span>PlayerName (localStorage):</span>
                    <span class="state-value" id="current-playername">Laddar...</span>
                </div>
                <div class="state-item">
                    <span>Firebase Status:</span>
                    <span class="state-value" id="firebase-status">Kontrollerar...</span>
                </div>
            </div>
        </div>
        <button onclick="refreshCurrentState()">üîÑ Uppdatera State</button>
    </div>

    <div class="test-section">
        <h2>Test 1: Ny anv√§ndare f√•r konsistent playerId</h2>
        <p>Detta test rensar localStorage och verifierar att ett nytt playerId genereras och persisterar.</p>
        <div class="test-grid">
            <button onclick="testNewUserPlayerId()">K√∂r Test</button>
            <button class="danger" onclick="clearLocalStorage()">‚ö†Ô∏è Rensa localStorage</button>
        </div>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Challenge skapas med korrekt playerId</h2>
        <p>Testar att challenges anv√§nder r√§tt playerId fr√•n localStorage, inte tempor√§ra ID:n.</p>
        <button onclick="testChallengePlayerId()">K√∂r Test</button>
        <div id="test2-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Ingen fallback ID-generering</h2>
        <p>Verifierar att systemet kastar fel ist√§llet f√∂r att generera tempor√§ra ID:n.</p>
        <button onclick="testNoFallbackId()">K√∂r Test</button>
        <div id="test3-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: PlayerId matchar i Firebase</h2>
        <p>Kontrollerar att playerId i localStorage matchar det som sparas i Firebase.</p>
        <button onclick="testFirebaseMatch()">K√∂r Test</button>
        <div id="test4-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 5: Komplett fl√∂de med alla komponenter</h2>
        <p>Testar hela fl√∂det: skapa anv√§ndare ‚Üí skapa challenge ‚Üí verifiera konsistens.</p>
        <button onclick="testCompleteFlow()">K√∂r Komplett Test</button>
        <div id="test5-result"></div>
    </div>

    <div class="test-section">
        <h2>üéØ Sammanfattning</h2>
        <div id="test-summary" class="result info">
            K√∂r testerna ovan f√∂r att verifiera Fas 1 implementationen.
        </div>
    </div>

    <!-- Firebase CDN Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/challengeSystem.js"></script>

    <script>
        // Initialize Firebase
        if (typeof initializeFirebase !== 'undefined') {
            const firebaseReady = initializeFirebase();
            console.log('Firebase initialization:', firebaseReady ? 'Success' : 'Failed');
        }

        // Initialize ChallengeSystem
        if (!window.ChallengeSystem) {
            window.ChallengeSystem = new ChallengeSystem();
            console.log('ChallengeSystem initialized');
        }

        // Test results tracking
        const testResults = {
            test1: 'pending',
            test2: 'pending',
            test3: 'pending',
            test4: 'pending',
            test5: 'pending'
        };

        // Utility functions
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `result ${type}`;
                element.textContent = message;
            }
        }

        function refreshCurrentState() {
            const playerId = localStorage.getItem('playerId');
            const playerName = localStorage.getItem('playerName');

            document.getElementById('current-playerid').textContent = playerId || 'Ingen';
            document.getElementById('current-playername').textContent = playerName || 'Ingen';

            // Check Firebase status - use the global firebaseInitialized variable
            if (typeof firebaseInitialized !== 'undefined' && firebaseInitialized === true) {
                document.getElementById('firebase-status').textContent = '‚úÖ Ansluten';
            } else if (typeof firebase !== 'undefined') {
                // Firebase library loaded but not initialized
                document.getElementById('firebase-status').textContent = '‚ö†Ô∏è Firebase laddad men ej initialiserad';
            } else {
                document.getElementById('firebase-status').textContent = '‚ùå Ej ansluten';
            }
        }

        function clearLocalStorage() {
            if (confirm('‚ö†Ô∏è Detta raderar ALL localStorage data. √Ñr du s√§ker?')) {
                localStorage.clear();
                showResult('test1-result', 'localStorage har rensats. Ladda om sidan f√∂r att testa ny anv√§ndare.', 'warning');
                refreshCurrentState();
            }
        }

        // Test 1: New user gets consistent playerId
        async function testNewUserPlayerId() {
            try {
                showResult('test1-result', 'Testar...', 'info');

                // Step 1: Clear and reload
                const oldPlayerId = localStorage.getItem('playerId');
                if (oldPlayerId) {
                    showResult('test1-result',
                        `Befintlig playerId finns: ${oldPlayerId}\nRensa localStorage f√∂rst f√∂r att testa ny anv√§ndare.`,
                        'warning');
                    testResults.test1 = 'fail';
                    updateSummary();
                    return;
                }

                // Step 2: Initialize player (simulate app.js behavior)
                let playerId = localStorage.getItem('playerId');
                if (!playerId) {
                    playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('playerId', playerId);
                }

                // Step 3: Verify persistence
                const storedId = localStorage.getItem('playerId');
                if (storedId === playerId) {
                    showResult('test1-result',
                        `‚úÖ PASS: Nytt playerId genererat och sparat!\nPlayerId: ${playerId}`,
                        'success');
                    testResults.test1 = 'pass';
                } else {
                    showResult('test1-result',
                        `‚ùå FAIL: PlayerId matchar inte!\nGenererat: ${playerId}\nSparat: ${storedId}`,
                        'error');
                    testResults.test1 = 'fail';
                }

                refreshCurrentState();
                updateSummary();

            } catch (error) {
                showResult('test1-result', `‚ùå Error: ${error.message}`, 'error');
                testResults.test1 = 'fail';
                updateSummary();
            }
        }

        // Test 2: Challenge uses correct playerId
        async function testChallengePlayerId() {
            try {
                showResult('test2-result', 'Testar challenge playerId...', 'info');

                const localPlayerId = localStorage.getItem('playerId');
                if (!localPlayerId) {
                    showResult('test2-result',
                        'Ingen playerId finns. K√∂r Test 1 f√∂rst f√∂r att skapa anv√§ndare.',
                        'warning');
                    testResults.test2 = 'fail';
                    updateSummary();
                    return;
                }

                // Mock the challenge creation scenario
                const testChallenge = {
                    playerName: 'TestPlayer',
                    score: 100,
                    questions: ['q1', 'q2'],
                    questionScores: [50, 50]
                };

                // Test that ChallengeSystem would use correct playerId
                // We can't actually create a challenge without a full game, but we can verify the logic
                const challengeSystem = window.ChallengeSystem;
                if (challengeSystem) {
                    // Verify that the system would throw error if no playerId
                    localStorage.removeItem('playerId');
                    let errorThrown = false;

                    try {
                        // This should fail now according to our fix
                        // We simulate the relevant part of completeChallenge
                        const playerId = localStorage.getItem('playerId');
                        if (!playerId) {
                            throw new Error('Player ID kr√§vs f√∂r att skapa utmaning.');
                        }
                    } catch (e) {
                        errorThrown = true;
                    }

                    // Restore playerId
                    localStorage.setItem('playerId', localPlayerId);

                    if (errorThrown) {
                        showResult('test2-result',
                            `‚úÖ PASS: System kr√§ver playerId f√∂r challenges\nIngen fallback ID-generering sker`,
                            'success');
                        testResults.test2 = 'pass';
                    } else {
                        showResult('test2-result',
                            `‚ùå FAIL: System till√•ter challenge utan playerId`,
                            'error');
                        testResults.test2 = 'fail';
                    }
                } else {
                    showResult('test2-result', 'ChallengeSystem inte laddat', 'error');
                    testResults.test2 = 'fail';
                }

                updateSummary();

            } catch (error) {
                showResult('test2-result', `‚ùå Error: ${error.message}`, 'error');
                testResults.test2 = 'fail';
                updateSummary();
            }
        }

        // Test 3: No fallback ID generation
        async function testNoFallbackId() {
            try {
                showResult('test3-result', 'Testar att ingen fallback ID genereras...', 'info');

                // Save current playerId
                const originalPlayerId = localStorage.getItem('playerId');

                // Remove playerId temporarily
                localStorage.removeItem('playerId');

                // Try to access playerId logic that should NOT have fallback
                let testPassed = true;
                let errorMessage = '';

                // Check that challengeSystem would fail without playerId
                try {
                    // Simulate the challenge creation code
                    const playerId = localStorage.getItem('playerId');
                    if (!playerId) {
                        throw new Error('Player ID kr√§vs');
                    }
                    // If we get here, fallback exists (bad)
                    testPassed = false;
                    errorMessage = 'Fallback ID generation fortfarande aktiv';
                } catch (e) {
                    // Good - error thrown as expected
                    testPassed = true;
                }

                // Restore original playerId
                if (originalPlayerId) {
                    localStorage.setItem('playerId', originalPlayerId);
                }

                if (testPassed) {
                    showResult('test3-result',
                        `‚úÖ PASS: Ingen fallback ID-generering sker\nSystemet kastar fel som f√∂rv√§ntat`,
                        'success');
                    testResults.test3 = 'pass';
                } else {
                    showResult('test3-result',
                        `‚ùå FAIL: ${errorMessage}`,
                        'error');
                    testResults.test3 = 'fail';
                }

                refreshCurrentState();
                updateSummary();

            } catch (error) {
                showResult('test3-result', `‚ùå Error: ${error.message}`, 'error');
                testResults.test3 = 'fail';
                updateSummary();
            }
        }

        // Test 4: Firebase match
        async function testFirebaseMatch() {
            try {
                showResult('test4-result', 'Kontrollerar Firebase-matchning...', 'info');

                const localPlayerId = localStorage.getItem('playerId');
                if (!localPlayerId) {
                    showResult('test4-result',
                        'Ingen playerId finns lokalt. K√∂r Test 1 f√∂rst.',
                        'warning');
                    testResults.test4 = 'fail';
                    updateSummary();
                    return;
                }

                // Check Firebase status using the global variable
                console.log('Firebase check:', {
                    firebaseInitialized: typeof firebaseInitialized !== 'undefined' ? firebaseInitialized : 'undefined',
                    FirebaseAPI: typeof FirebaseAPI !== 'undefined' ? 'exists' : 'undefined',
                    db: typeof db !== 'undefined' ? 'exists' : 'undefined'
                });

                if (typeof firebaseInitialized === 'undefined' || !firebaseInitialized) {
                    showResult('test4-result',
                        `Firebase √§r inte anslutet. Status: ${typeof firebaseInitialized !== 'undefined' ? firebaseInitialized : 'undefined'}\nKontrollera konsolen f√∂r mer info.`,
                        'warning');
                    testResults.test4 = 'pending';
                    updateSummary();
                    return;
                }

                // Try to get player from Firebase
                try {
                    const firebasePlayer = await FirebaseAPI.getPlayer(localPlayerId);

                    if (firebasePlayer && firebasePlayer.playerId === localPlayerId) {
                        showResult('test4-result',
                            `‚úÖ PASS: PlayerId matchar i Firebase!\nLokal: ${localPlayerId}\nFirebase: ${firebasePlayer.playerId}`,
                            'success');
                        testResults.test4 = 'pass';
                    } else if (!firebasePlayer) {
                        // Player doesn't exist in Firebase yet - this is ok for new users
                        showResult('test4-result',
                            `‚ö†Ô∏è INFO: Spelare finns inte i Firebase √§nnu (normal f√∂r nya anv√§ndare)\nLokal playerId: ${localPlayerId}`,
                            'info');
                        testResults.test4 = 'pass';
                    } else {
                        showResult('test4-result',
                            `‚ùå FAIL: PlayerId matchar inte!\nLokal: ${localPlayerId}\nFirebase: ${firebasePlayer?.playerId}`,
                            'error');
                        testResults.test4 = 'fail';
                    }
                } catch (error) {
                    showResult('test4-result',
                        `‚ö†Ô∏è Firebase-fel: ${error.message}\n(Detta kan vara normalt om spelaren inte finns √§nnu)`,
                        'warning');
                    testResults.test4 = 'pending';
                }

                updateSummary();

            } catch (error) {
                showResult('test4-result', `‚ùå Error: ${error.message}`, 'error');
                testResults.test4 = 'fail';
                updateSummary();
            }
        }

        // Test 5: Complete flow
        async function testCompleteFlow() {
            try {
                showResult('test5-result', 'K√∂r komplett fl√∂destest...', 'info');

                let messages = [];

                // Step 1: Ensure playerId exists
                let playerId = localStorage.getItem('playerId');
                if (!playerId) {
                    playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('playerId', playerId);
                    messages.push(`‚úÖ Nytt playerId skapat: ${playerId}`);
                } else {
                    messages.push(`‚úÖ Befintligt playerId anv√§nds: ${playerId}`);
                }

                // Step 2: Verify consistency
                const storedId = localStorage.getItem('playerId');
                if (storedId === playerId) {
                    messages.push('‚úÖ PlayerId konsistent i localStorage');
                } else {
                    messages.push(`‚ùå PlayerId inkonsistent! F√∂rv√§ntat: ${playerId}, Faktiskt: ${storedId}`);
                    testResults.test5 = 'fail';
                }

                // Step 3: Test challenge system requirement
                localStorage.removeItem('playerId');
                let errorThrown = false;
                try {
                    const testId = localStorage.getItem('playerId');
                    if (!testId) {
                        throw new Error('Player ID kr√§vs');
                    }
                } catch (e) {
                    errorThrown = true;
                    messages.push('‚úÖ System kastar fel utan playerId (korrekt beteende)');
                }

                if (!errorThrown) {
                    messages.push('‚ùå System till√•ter operation utan playerId');
                    testResults.test5 = 'fail';
                }

                // Restore playerId
                localStorage.setItem('playerId', playerId);
                messages.push(`‚úÖ PlayerId √•terst√§llt: ${playerId}`);

                // Step 4: Final verification
                const finalId = localStorage.getItem('playerId');
                if (finalId === playerId) {
                    messages.push('‚úÖ Slutgiltig verifiering: PlayerId konsistent genom hela fl√∂det');
                    testResults.test5 = 'pass';
                    showResult('test5-result', messages.join('\n'), 'success');
                } else {
                    messages.push(`‚ùå Slutgiltig verifiering misslyckades: ${finalId} !== ${playerId}`);
                    testResults.test5 = 'fail';
                    showResult('test5-result', messages.join('\n'), 'error');
                }

                refreshCurrentState();
                updateSummary();

            } catch (error) {
                showResult('test5-result', `‚ùå Error: ${error.message}`, 'error');
                testResults.test5 = 'fail';
                updateSummary();
            }
        }

        function updateSummary() {
            const summary = document.getElementById('test-summary');
            let passCount = 0;
            let failCount = 0;
            let pendingCount = 0;

            for (const [test, result] of Object.entries(testResults)) {
                if (result === 'pass') passCount++;
                else if (result === 'fail') failCount++;
                else pendingCount++;
            }

            let summaryHtml = `üìä Testresultat:\n`;
            summaryHtml += `‚úÖ Godk√§nda: ${passCount}/5\n`;
            summaryHtml += `‚ùå Misslyckade: ${failCount}/5\n`;
            summaryHtml += `‚è≥ V√§ntande: ${pendingCount}/5\n\n`;

            if (passCount === 5) {
                summaryHtml += `üéâ ALLA TESTER GODK√ÑNDA! Fas 1 implementation √§r klar.`;
                summary.className = 'result success';
            } else if (failCount > 0) {
                summaryHtml += `‚ö†Ô∏è Vissa tester misslyckades. Kontrollera implementationen.`;
                summary.className = 'result error';
            } else {
                summaryHtml += `üí° K√∂r alla tester f√∂r att verifiera implementation.`;
                summary.className = 'result info';
            }

            summary.textContent = summaryHtml;
        }

        // Initialize on load
        window.addEventListener('load', () => {
            refreshCurrentState();
            console.log('Test page loaded. ChallengeSystem available:', !!window.ChallengeSystem);
            console.log('FirebaseAPI available:', typeof FirebaseAPI !== 'undefined');
        });
    </script>
</body>
</html>